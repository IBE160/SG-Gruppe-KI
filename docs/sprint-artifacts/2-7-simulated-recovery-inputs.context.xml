<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.7</storyId>
    <title>Simulated Recovery Inputs</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-7-simulated-recovery-inputs.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>to be able to input simulated recovery data (HRV, sleep)</iWant>
    <soThat>I can validate the AI's ability to adapt plans based on recovery metrics</soThat>
    <tasks>
      - [ ] **Task 1: Backend API Update** (AC: #1)
        - [ ] Update the `POST /api/v1/workout_plans/generate` endpoint to accept optional `simulated_recovery_data` in the request body. (Source: `tech-spec-epic-2.md#APIs-and-Interfaces`)
        - [ ] Modify the `AI Plan Generation Service` to include this simulated data in the prompt sent to the OpenAI API.
      - [ ] **Task 2: Testing** (AC: #1)
        - [ ] Add Pytest integration tests for the `POST /api/v1/workout_plans/generate` endpoint with simulated recovery data.
        - [ ] Create test cases with different recovery data (e.g., good, average, poor) and assert that the generated plan is adjusted appropriately (e.g., by checking for keywords like "lower intensity" or by comparing generated volume).
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** the AI plan generation endpoint, **when** simulated recovery data is included in the prompt, **then** the generated workout plan is adjusted accordingly (e.g., lower volume for poor recovery).
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 2.7: Simulated Recovery Inputs</section>
        <snippet>As a Developer, I want to be able to input simulated recovery data (HRV, sleep), so that I can validate the AI's ability to adapt plans based on recovery metrics.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Training &amp; Logging</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/workout_plans/generate: (Optional) { "force_regenerate": "boolean", "simulated_recovery_data": { "hrv": "float", "sleep": "int" } }</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>AI Integration and Prompting</section>
        <snippet>The FastAPI (Orchestration Layer): Fetches all required data from Supabase for a given user. Constructs a detailed, structured prompt using the System Prompt and a User Prompt Template. Sends the request to the OpenAI API.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/api/v1/workout_plans.py</path>
        <kind>api</kind>
        <symbol>POST /api/v1/workout_plans/generate</symbol>
        <lines></lines>
        <reason>This file will be updated to accept optional simulated recovery data.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/services/ai_plan_service.py</path>
        <kind>service</kind>
        <symbol>AIPlanService</symbol>
        <lines></lines>
        <reason>This service will be modified to include the simulated data in the AI prompt.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="pydantic" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>This feature is for developer validation and should not have a user-facing UI.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Generate AI Workout Plan (with simulated data)</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/workout_plans/generate</signature>
      <path>backend/app/api/v1/workout_plans.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend integration tests should be written with Pytest.
    </standards>
    <locations>
      <location type="Backend">/backend/tests/</location>
    </locations>
    <ideas>
      <idea ac_id="1">Write an integration test for the `POST /api/v1/workout_plans/generate` endpoint that passes various simulated recovery data and validates the AI's response.</idea>
    </ideas>
  </tests>
</story-context>
