<story-context id="1-4-user-profile-management" v="1.1">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>User Profile Management</title>
    <status>drafted</status>
    <generatedAt>2025-12-15</generatedAt>
    <generator>BMAD Story Context Workflow (Regenerated)</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-user-profile-management.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>a user</asA>
    <iWant>to view and edit my profile information, goals, and equipment settings</iWant>
    <soThat>I can keep my personal data up-to-date and influence AI plan generation</soThat>
    <tasks>
- [x] **Task 1: Implement Profile UI Shell & Navigation (AC: 1)**
  - [x] Create main layout (`apps/web/src/app/settings/profile/layout.tsx`)
  - [x] Add navigation entry from Settings
  - [x] Create `profileStore.ts`
  - [x] Write unit tests

- [x] **Task 2: Implement User Profile View (AC: 2)**
  - [x] Create components to show user info
  - [x] Fetch from `GET /users/me`
  - [x] Bind to Zustand
  - [x] Write unit tests

- [x] **Task 3: Implement User Profile Edit Functionality (AC: 3)**
  - [x] Create editable components
  - [x] Client-side validation
  - [x] Integrate Zustand editing state
  - [x] Implement Save
  - [x] Write unit tests

- [ ] **Task 4: Implement Backend API for User Profile Management (AC: 1.4.3)**
  - [ ] Resolve Pytest `ModuleNotFoundError`
  - [ ] Create Pydantic models (`UserProfileUpdate`, etc.)
  - [ ] Create FastAPI router with `GET /users/me` and `PUT /users/me`
  - [ ] Implement `user_service.py`
  - [ ] Add router to `main.py`
  - [ ] Write integration tests

- [x] **Task 5: Finalize Data Submission & Redirection (AC: 1.4.3)**
  - [x] Implement PUT request logic
  - [x] Handle API errors/success
  - [x] Reload profile data on success
  - [x] Write E2E Playwright test

- [x] **Task 6: Ensure full testing coverage**
  - [x] Tests for custom text input (AC: 1.4.2, 1.4.3)
    </tasks>
  </story>
  <acceptanceCriteria>
    <criterion>AC1.4.1: A logged-in user can navigate to a profile management page.</criterion>
    <criterion>AC1.4.2: The page displays the user's current goals, equipment, and personal information.</criterion>
    <criterion>AC1.4.3: The user can successfully modify their details, and the changes are persisted in the database.</criterion>
  </acceptanceCriteria>
  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>APIs and Interfaces</section>
        <snippet>GET /users/me and PUT /users/me for fetching and updating user profiles.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 1.4: User Profile Management</section>
        <snippet>As a user, I want to view and edit my profile information, goals, and equipment settings, so that I can keep my personal data up-to-date and influence AI plan generation.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction</title>
        <section>Flow 18: Change Settings (General, Health, Playback & Privacy)</section>
        <snippet>The User Profile Management is expected to be part of the settings section, likely under Privacy & Account Settings.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/web/src/app/settings/profile/layout.tsx</path>
        <kind>component-layout</kind>
        <reason>Exists. UI shell for the profile page.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/settings/profile/page.tsx</path>
        <kind>component-page</kind>
        <reason>Exists. Entry point for the profile page.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/store/profileStore.ts</path>
        <kind>state-management</kind>
        <reason>Exists. Zustand store for managing profile state.</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/models/user.py</path>
        <kind>data-model</kind>
        <reason>Exists. Pydantic models for user data.</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/api/user.py</path>
        <kind>api-endpoint</kind>
        <reason>Exists. FastAPI router for user profile endpoints.</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/services/user_service.py</path>
        <kind>service</kind>
        <reason>Exists. Backend service for user profile business logic.</reason>
      </artifact>
      <artifact>
        <path>apps/api/tests/test_user.py</path>
        <kind>test</kind>
        <reason>Exists. Tests for the user profile backend endpoints.</reason>
      </artifact>
      <artifact>
        <path>tests/e2e/profile-management.spec.ts</path>
        <kind>e2e-test</kind>
        <reason>Exists. E2E test for the profile management feature.</reason>
      </artifact>
    </code>
  </artifacts>
  <constraints>
    <constraint>All profile management API endpoints must be protected by JWT authentication.</constraint>
    <constraint>A user must only be able to view and edit their own profile data. This is enforced by Row-Level Security (RLS) in Supabase.</constraint>
    <constraint>The backend must use Pydantic models for validating all incoming request data.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Get User Profile</name>
      <kind>REST Endpoint</kind>
      <signature>GET /api/v1/users/me</signature>
      <path>apps/api/app/api/user.py</path>
    </interface>
    <interface>
      <name>Update User Profile</name>
      <kind>REST Endpoint</kind>
      <signature>PUT /api/v1/users/me</signature>
      <path>apps/api/app/api/user.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>The project uses a three-tiered testing strategy: Unit Tests (Jest/RTL), Integration Tests (Pytest), and End-to-End Tests (Playwright).</standards>
    <locations>
        <location>apps/web/src/app/settings/profile/__tests__/</location>
        <location>apps/api/tests/</location>
        <location>tests/e2e/</location>
    </locations>
    <ideas>
      <idea>E2E test: User can navigate to the profile management page from the settings menu.</idea>
      <idea>Integration test: `GET /api/v1/users/me` returns the correct profile data for the authenticated user.</idea>
      <idea>Integration test: `PUT /api/v1/users/me` successfully updates the user's data in the database.</idea>
    </ideas>
  </tests>
</story-context>