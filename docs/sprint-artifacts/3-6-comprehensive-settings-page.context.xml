<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.6</storyId>
    <title>Comprehensive Settings Page</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-6-comprehensive-settings-page.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>a comprehensive settings page to manage my general preferences, appearance, music, AI personalization, privacy, and account</iWant>
    <soThat>I have full control over my app experience</soThat>
    <tasks>
      - [ ] **Task 1: Frontend UI for Settings Page** (AC: #1, #2)
        - [ ] Create a new page/route for the comprehensive settings page.
        - [ ] Design and implement UI components for various settings categories.
        - [ ] Implement client-side logic to fetch current settings using `GET /api/v1/user_settings`.
        - [ ] Implement client-side logic to update settings using `PUT /api/v1/user_settings/{key}`.
      - [ ] **Task 2: Backend API for User Settings** (AC: #1, #2)
        - [ ] Create a `User Settings API` (`app/api/v1/user_settings.py`) with endpoints for CRUD operations on user settings. (Source: `tech-spec-epic-3.md#APIs-and-Interfaces`)
        - [ ] Implement `GET /api/v1/user_settings` to retrieve all settings for the authenticated user.
        - [ ] Implement `PUT /api/v1/user_settings/{key}` to update a specific user setting.
        - [ ] Implement Pydantic schemas for request validation.
      - [ ] **Task 3: Data Model &amp; Schema Verification** (AC: #2)
        - [ ] Verify the `user_settings` table schema in Supabase (`id`, `user_id`, `setting_key`, `setting_value`). (Source: `tech-spec-epic-3.md#Data-Models-and-Contracts`)
        - [ ] Ensure RLS policies are applied to this table.
      - [ ] **Task 4: Testing** (AC: #1, #2)
        - [ ] Add Pytest integration tests for the `User Settings API` endpoints.
        - [ ] Add React Testing Library tests for the settings UI components.
        - [ ] Add Playwright E2E tests for navigating to the settings page, modifying settings, and verifying persistence.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** an authenticated user, **when** they navigate to the settings page, **then** they can view and modify various categories of settings (General, Appearance, Performance &amp; Data, Music &amp; Playback, AI &amp; Personalization, Privacy &amp; Account).
    2.  **And** changes are persisted in the `user_settings` table.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 3.6: Comprehensive Settings Page</section>
        <snippet>As a User, I want a comprehensive settings page to manage my general preferences, appearance, music, AI personalization, privacy, and account, so that I have full control over my app experience.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>Services and Modules</section>
        <snippet>Settings Module: Comprehensive UI for managing user preferences across various categories. Interacts with User Settings API.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>APIs and Interfaces</section>
        <snippet>GET /api/v1/user_settings, PUT /api/v1/user_settings/{key}</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Data Architecture</section>
        <snippet>The application will utilize PostgreSQL, managed via Supabase, for its primary data persistence.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/api/v1/user_settings.py</path>
        <kind>api</kind>
        <symbol>GET /api/v1/user_settings, PUT /api/v1/user_settings/{key}</symbol>
        <lines></lines>
        <reason>This new file will contain the API endpoints for user settings management.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/schemas/user_setting.py</path>
        <kind>schema</kind>
        <symbol>UserSetting</symbol>
        <lines></lines>
        <reason>This new file will contain the Pydantic schemas for user settings data.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="pydantic" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>Row-Level Security policies must be applied to the `user_settings` table.</constraint>
    <constraint>Changes to settings must be persisted securely and reliably.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Get User Settings</name>
      <kind>REST Endpoint</kind>
      <signature>GET /api/v1/user_settings</signature>
      <path>backend/app/api/v1/user_settings.py</path>
    </interface>
    <interface>
      <name>Update User Setting</name>
      <kind>REST Endpoint</kind>
      <signature>PUT /api/v1/user_settings/{key}</signature>
      <path>backend/app/api/v1/user_settings.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend integration tests should be written with Pytest. Frontend component tests should use React Testing Library. End-to-end tests for user flows should be implemented with Playwright.
    </standards>
    <locations>
      <location type="Backend">/backend/tests/</location>
      <location type="Frontend">Component-colocated tests or a central /app/tests/ directory.</location>
      <location type="E2E">/tests/e2e/</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">Write an integration test for the `User Settings API` endpoints, covering fetching and updating various settings.</idea>
      <idea ac_id="1, 2">Write component tests for the settings UI, verifying rendering and interaction for different setting types.</idea>
      <idea ac_id="1, 2">Write an E2E test for navigating to the settings page, modifying a setting, and verifying that the change is persisted correctly.</idea>
    </ideas>
  </tests>
</story-context>
