<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>BPM-Matched Session Mix Generation</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-3-bpm-matched-session-mix-generation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>the AI to generate a Spotify playlist with BPM-matched music for my workout</iWant>
    <soThat>my music aligns with the intensity of my training phases</soThat>
    <tasks>
      - [ ] **Task 1: Backend API for Session Mix Generation** (AC: #1, #2)
        - [ ] Create a `POST /api/v1/spotify/mix` endpoint in FastAPI. (Source: `tech-spec-epic-3.md#APIs-and-Interfaces`)
        - [ ] Implement the `AI Music Service` to integrate with OpenAI API and Spotify Web API. (Source: `tech-spec-epic-3.md#Services-and-Modules`)
        - [ ] Implement logic to retrieve user's Spotify listening history/playlists and call Spotify Web API for audio features (BPM).
        - [ ] Use AI (OpenAI API) to curate a playlist matching BPM and workout intensity.
        - [ ] Create a new playlist on Spotify via Spotify Web API.
        - [ ] Store `spotify_playlist_uri` and `track_analysis_cache` in the `workout_music_sessions` table. (Source: `tech-spec-epic-3.md#Data-Models-and-Contracts`)
      - [ ] **Task 2: Frontend UI for Session Mix Request** (AC: #1)
        - [ ] Add a "Request Session Mix" button or similar interaction point in the Workout Player or a related module.
        - [ ] Implement client-side logic to call the `POST /api/v1/spotify/mix` endpoint.
      - [ ] **Task 3: Data Model &amp; Schema Verification** (AC: #2)
        - [ ] Verify the `workout_music_sessions` table schema in Supabase (`id`, `workout_plan_id`, `spotify_playlist_uri`, `target_bpm_min`, `target_bpm_max`, `mood_tags`, `track_analysis_cache`). (Source: `tech-spec-epic-3.md#Data-Models-and-Contracts`)
      - [ ] **Task 4: Testing** (AC: #1, #2)
        - [ ] Add Pytest integration tests for the `POST /api/v1/spotify/mix` endpoint, mocking OpenAI and Spotify API calls.
        - [ ] Test the AI's ability to generate appropriate playlists based on BPM and workout intensity.
        - [ ] Add Playwright E2E tests for requesting a session mix and verifying a new playlist is created in Spotify.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** a connected Spotify account and a generated workout plan, **when** the user requests a "Session Mix", **then** the AI analyzes their listening history and track BPMs.
    2.  **And** a new Spotify playlist is created and populated with BPM-matched tracks according to the workout phases.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 3.3: BPM-Matched Session Mix Generation</section>
        <snippet>As a User, I want the AI to generate a Spotify playlist with BPM-matched music for my workout, so that my music aligns with the intensity of my training phases.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>Services and Modules</section>
        <snippet>AI Music Service (`app/services/ai_music_service.py`): Integrates with OpenAI API and Spotify Web API to generate BPM-matched session mixes based on workout plan and user listening history.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/spotify/mix: Requests AI to generate a BPM-matched session mix.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Spotify Integration</section>
        <snippet>The backend (`AI Music Service`): Retrieves user's Spotify listening history/playlists. Calls Spotify Web API to get audio features (BPM) for tracks. Uses AI (OpenAI API) to curate a playlist matching BPM and workout intensity. Creates new playlist on Spotify via Spotify Web API.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/services/ai_music_service.py</path>
        <kind>service</kind>
        <symbol>AIMusicService</symbol>
        <lines></lines>
        <reason>This new service will contain the logic for generating BPM-matched Spotify playlists.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/api/v1/spotify.py</path>
        <kind>api</kind>
        <symbol>POST /api/v1/spotify/mix</symbol>
        <lines></lines>
        <reason>This file will be updated with the new endpoint for session mix generation.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="pydantic" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
        <dependency name="openai" version="" type="runtime" />
        <dependency name="spotipy" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>Must use OpenAI API for playlist curation logic.</constraint>
    <constraint>Must use Spotify Web API for audio analysis and playlist creation.</constraint>
    <constraint>A connected Spotify account is a prerequisite.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Generate Session Mix</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/spotify/mix</signature>
      <path>backend/app/api/v1/spotify.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend integration tests should be written with Pytest, mocking calls to the external OpenAI and Spotify APIs. E2E tests should use Playwright to automate the user flow.
    </standards>
    <locations>
      <location type="Backend">/backend/tests/</location>
      <location type="E2E">/tests/e2e/</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">Write an integration test for the `POST /api/v1/spotify/mix` endpoint, mocking external API calls.</idea>
      <idea ac_id="1, 2">Write an E2E test that requests a session mix and verifies that a new playlist is created on a test Spotify account.</idea>
    </ideas>
  </tests>
</story-context>
