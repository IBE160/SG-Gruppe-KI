<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Display & Review Daily Plan</title>
    <status>drafted</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>C:\Users\Administrator\SG-Gruppe-KI\docs\sprint-artifacts\2-3-Display & Review Daily Plan.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to review the AI-generated daily workout plan, including any adaptations, and have the option to confirm or edit it</iWant>
    <soThat>I maintain control over my training.</soThat>
    <tasks>
      <task category="Task 1: Implement Plan Review UI Component (AC: 1, 2, 3)">
        <description>Subtask 1.1: Create `apps/web/src/components/PlanReview/PlanReview.tsx` based on `Flow 6, Screen 3` (`screen_3/code.html`) from `ux-design-direction.md`.</description>
        <status>pending</status>
      </task>
      <task category="Task 1: Implement Plan Review UI Component (AC: 1, 2, 3)">
        <description>Subtask 1.2: Implement UI to display the structured JSON workout plan in a user-friendly format (e.g., list of exercises, sets, reps, RPE).</description>
        <status>pending</status>
      </task>
      <task category="Task 1: Implement Plan Review UI Component (AC: 1, 2, 3)">
        <description>Subtask 1.3: Implement logic to visually highlight AI adaptations and display the `ai_explanation`.</description>
        <status>pending</status>
      </task>
      <task category="Task 1: Implement Plan Review UI Component (AC: 1, 2, 3)">
        <description>Subtask 1.4: Add `[ Confirm Plan ]` and `[ Edit Plan ]` buttons.</description>
        <status>pending</status>
      </task>
      <task category="Task 1: Implement Plan Review UI Component (AC: 1, 2, 3)">
        <description>Subtask 1.5: Write unit tests (Jest/RTL) for the `PlanReview` component, verifying rendering and display of plan details and adaptations.</description>
        <status>pending</status>
      </task>
      <task category="Task 2: Implement Plan Review State Management">
        <description>Subtask 2.1: Create `apps/web/src/store/planReviewStore.ts` using Zustand to manage the state of the currently reviewed plan and any temporary edits.</description>
        <status>pending</status>
      </task>
      <task category="Task 2: Implement Plan Review State Management">
        <description>Subtask 2.2: Integrate the `planReviewStore` with the `PlanReview.tsx` component.</description>
        <status>pending</status>
      </task>
      <task category="Task 2: Implement Plan Review State Management">
        <description>Subtask 2.3: Write unit tests for `planReviewStore.ts`.</description>
        <status>pending</status>
      </task>
      <task category="Task 3: Implement Plan Fetching and Confirmation Logic (AC: 4, 6, 7)">
        <description>Subtask 3.1: Implement a frontend utility or hook to fetch the plan (e.g., `GET /api/v1/plans/{planId}`) and integrate it with `PlanReview.tsx`.</description>
        <status>pending</status>
      </task>
      <task category="Task 3: Implement Plan Fetching and Confirmation Logic (AC: 4, 6, 7)">
        <description>Subtask 3.2: Implement logic to send plan confirmation (e.g., `POST /api/v1/plans/{planId}/confirm`).</description>
        <status>pending</status>
      </task>
      <task category="Task 3: Implement Plan Fetching and Confirmation Logic (AC: 4, 6, 7)">
        <description>Subtask 3.3: Handle success/error states for fetching and confirmation, including redirection to the "Plan Confirmed!" screen (`Flow 6, Screen 4`).</description>
        <status>pending</status>
      </task>
      <task category="Task 3: Implement Plan Fetching and Confirmation Logic (AC: 4, 6, 7)">
        <description>Subtask 3.4: Write integration tests (Jest) for fetching and confirmation logic, mocking API calls.</description>
        <status>pending</status>
      </task>
      <task category="Task 4: Implement Backend Endpoints for Plan Review and Confirmation (AC: 6, 7)">
        <description>Subtask 4.1: Extend `apps/api/app/api/plans.py` with a `GET /plans/{planId}` endpoint to retrieve a workout plan by ID from the `WorkoutPlans` table.</description>
        <status>pending</status>
      </task>
      <task category="Task 4: Implement Backend Endpoints for Plan Review and Confirmation (AC: 6, 7)">
        <description>Subtask 4.2: Extend `apps/api/app/api/plans.py` with a `POST /plans/{planId}/confirm` endpoint to update the `is_confirmed` status in the `WorkoutPlans` table.</description>
        <status>pending</status>
      </task>
      <task category="Task 4: Implement Backend Endpoints for Plan Review and Confirmation (AC: 6, 7)">
        <description>Subtask 4.3: Update `apps/api/app/services/plans_service.py` to include methods for retrieving and confirming plans.</description>
        <status>pending</status>
      </task>
      <task category="Task 4: Implement Backend Endpoints for Plan Review and Confirmation (AC: 6, 7)">
        <description>Subtask 4.4: Write integration tests (Pytest) for `GET /plans/{planId}` and `POST /plans/{planId}/confirm`, mocking Supabase interactions. (Prioritize resolving `ModuleNotFoundError` tech debt).</description>
        <status>pending</status>
      </task>
      <task category="Task 5: E2E Testing">
        <description>Subtask 5.1: Write an E2E test (Playwright) that simulates a user generating a plan (using mocked AI), reviewing it, confirming it, and verifying redirection.</description>
        <status>pending</status>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">The AI-generated plan (obtained from the backend) is displayed to the user in a clear and readable format.</criterion>
    <criterion id="2">Any adaptations made by the AI to the plan are visually highlighted, along with a corresponding explanation of why the adaptation occurred.</criterion>
    <criterion id="3">The user is presented with distinct options to `[ Confirm Plan ]` or `[ Edit Plan ]`.</criterion>
    <criterion id="4">Selecting `[ Confirm Plan ]` sends a request to the backend to confirm the plan and redirects the user to a "Plan Confirmed!" screen (Flow 6, Screen 4) before navigating to the Dashboard.</criterion>
    <criterion id="5">Selecting `[ Edit Plan ]` allows the user to make modifications to the plan before confirmation (implementation of actual editing functionality can be a separate story if complex).</criterion>
    <criterion id="6">The `GET /plans/{planId}` endpoint successfully retrieves a stored workout plan by its ID.</criterion>
    <criterion id="7">The `POST /plans/{planId}/confirm` endpoint successfully marks a plan as confirmed in the `WorkoutPlans` table.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (Frontend Framework)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | Framework | Next.js (with App Router) | | All frontend features | Provides a best-in-class React framework with SSR, SSG, and a strong ecosystem. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (State Management)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | State Management | Zustand | 5.0.9 | All interactive frontend features | A lightweight, simple, and powerful state management solution that is easy to learn and integrates well with React/Next.js. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Project Structure (Frontend)</title>
        <section>Project Structure</section>
        <snippet>
          my-ai-trainer/
          ├── apps/
          │   ├── web/                     # Next.js Frontend
          │   │   ├── src/
          │   │   │   ├── app/             # App Router: pages, layouts, components
          │   │   │   ├── components/      # Shared UI components
          │   │   │   ├── lib/             # Helper functions, utilities
          │   │   │   ├── store/           # Zustand state management stores
          │   │   │   └── styles/          # Global styles
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Backend (FastAPI) for AI Integration</title>
        <section>FR Category to Architecture Mapping</section>
        <snippet>
          -   **Backend (FastAPI `api` app):** Responsible for all business logic, data processing, and AI integration.
              -   Handles: AI Daily-Plan Generation...
              -   Interacts directly with the Supabase (PostgreSQL) database.
              -   Provides the REST API for the frontend.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Novel Architectural Patterns (Adaptive Workout Dialogue - Plan Review UI)</title>
        <section>Novel Architectural Patterns</section>
        <snippet>
          ### Pattern: Adaptive Workout Dialogue

          ...

          **Components:**
          ...
          4.  **Plan Review UI (Frontend):** The screen where the user sees the proposed (and potentially modified) plan and the AI's reasoning.
          ...
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6: Generate AI Daily Plan</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          ### **Flow 6: Generate AI Daily Plan**

          *   **Purpose:** Enable users to provide real-time context to the AI and receive an adaptive, personalized workout plan.
          *   **Core User Journey:** User accesses a "Context Window," inputs their current state. AI generates a plan, which is presented for review and optional adjustment before confirmation.
          *   **Key UX Direction:** Smart Context Window (pre-fills suggestions), transparent plan changes, and an "Edit Plan" option.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6, Screen 3 (Plan Review UI)</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          When I am presented with the "Review Proposed Plan" screen (Flow 6, Screen 3 - `screen_3/code.html`)
          Then I can see the full workout plan, broken down by exercises and sets
          And any AI adaptations are visually highlighted and explained (e.g., "Heard you were feeling a bit low on energy...")
          And I have options to `[ Confirm Plan ]` or `[ Edit Plan ]`
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6, Screen 4 ("Plan Confirmed!")</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          And confirming the plan leads to the "Plan Confirmed!" screen (Flow 6, Screen 4 - `screen_4/code.html`) before redirecting to Dashboard
        </snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic 2, Story 2.3: Display & Review Daily Plan</title>
        <section>Epic 2: AI-Powered Training & Logging</section>
        <snippet>
          ### Story 2.3: Display & Review Daily Plan
          As a user,
          I want to review the AI-generated daily workout plan, including any adaptations, and have the option to confirm or edit it,
          So that I maintain control over my training.

          **Acceptance Criteria:**
          *   **AC2.3.1:** The AI-generated plan is displayed to the user in a clear, readable format.
          *   **AC2.3.2:** Any AI adaptations are visually highlighted with the corresponding explanation.
          *   **AC2.3.3:** The user has options to `[ Confirm Plan ]` or `[ Edit Plan ]`.

          **Prerequisites:** Story 2.1, 2.2

          **Technical Notes:** Implement frontend UI for plan review as per `ux_design_content` (Flow 6, Screen 3). Implement state management (Zustand) to display plan data. Call backend API to confirm or initiate editing.
        </snippet>
      </artifact>
    </docs>
  <artifacts>
    <docs>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (Frontend Framework)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | Framework | Next.js (with App Router) | | All frontend features | Provides a best-in-class React framework with SSR, SSG, and a strong ecosystem. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (State Management)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | State Management | Zustand | 5.0.9 | All interactive frontend features | A lightweight, simple, and powerful state management solution that is easy to learn and integrates well with React/Next.js. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Project Structure (Frontend)</title>
        <section>Project Structure</section>
        <snippet>
          my-ai-trainer/
          ├── apps/
          │   ├── web/                     # Next.js Frontend
          │   │   ├── src/
          │   │   │   ├── app/             # App Router: pages, layouts, components
          │   │   │   ├── components/      # Shared UI components
          │   │   │   ├── lib/             # Helper functions, utilities
          │   │   │   ├── store/           # Zustand state management stores
          │   │   │   └── styles/          # Global styles
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Backend (FastAPI) for AI Integration</title>
        <section>FR Category to Architecture Mapping</section>
        <snippet>
          -   **Backend (FastAPI `api` app):** Responsible for all business logic, data processing, and AI integration.
              -   Handles: AI Daily-Plan Generation...
              -   Interacts directly with the Supabase (PostgreSQL) database.
              -   Provides the REST API for the frontend.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Novel Architectural Patterns (Adaptive Workout Dialogue - Plan Review UI)</title>
        <section>Novel Architectural Patterns</section>
        <snippet>
          ### Pattern: Adaptive Workout Dialogue

          ...

          **Components:**
          ...
          4.  **Plan Review UI (Frontend):** The screen where the user sees the proposed (and potentially modified) plan and the AI's reasoning.
          ...
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6: Generate AI Daily Plan</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          ### **Flow 6: Generate AI Daily Plan**

          *   **Purpose:** Enable users to provide real-time context to the AI and receive an adaptive, personalized workout plan.
          *   **Core User Journey:** User accesses a "Context Window," inputs their current state. AI generates a plan, which is presented for review and optional adjustment before confirmation.
          *   **Key UX Direction:** Smart Context Window (pre-fills suggestions), transparent plan changes, and an "Edit Plan" option.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6, Screen 3 (Plan Review UI)</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          When I am presented with the "Review Proposed Plan" screen (Flow 6, Screen 3 - `screen_3/code.html`)
          Then I can see the full workout plan, broken down by exercises and sets
          And any AI adaptations are visually highlighted and explained (e.g., "Heard you were feeling a bit low on energy...")
          And I have options to `[ Confirm Plan ]` and `[ Edit Plan ]`
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6, Screen 4 ("Plan Confirmed!")</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          And confirming the plan leads to the "Plan Confirmed!" screen (Flow 6, Screen 4 - `screen_4/code.html`) before redirecting to Dashboard
        </snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic 2, Story 2.3: Display & Review Daily Plan</title>
        <section>Epic 2: AI-Powered Training & Logging</section>
        <snippet>
          ### Story 2.3: Display & Review Daily Plan
          As a user,
          I want to review the AI-generated daily workout plan, including any adaptations, and have the option to confirm or edit it,
          So that I maintain control over my training.

          **Acceptance Criteria:**
          *   **AC2.3.1:** The AI-generated plan is displayed to the user in a clear, readable format.
          *   **AC2.3.2:** Any AI adaptations are visually highlighted with the corresponding explanation.
          *   **AC2.3.3:** The user has options to `[ Confirm Plan ]` or `[ Edit Plan ]`.

          **Prerequisites:** Story 2.1, 2.2

          **Technical Notes:** Implement frontend UI for plan review as per `ux_design_content` (Flow 6, Screen 3). Implement state management (Zustand) to display plan data. Call backend API to confirm or initiate editing.
        </snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>apps/web/src/components/PlanReview/PlanReview.tsx</path>
        <kind>UI Component</kind>
        <symbol>PlanReview</symbol>
        <lines></lines>
        <reason>React component for displaying and reviewing the plan</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/store/planReviewStore.ts</path>
        <kind>Zustand Store</kind>
        <symbol>planReviewStore</symbol>
        <lines></lines>
        <reason>Manages the state of the currently reviewed plan and any temporary edits</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/planApi.ts</path>
        <kind>Frontend Utility/Hook</kind>
        <symbol></symbol>
        <lines></lines>
        <reason>Fetches plan (`GET /api/v1/plans/{planId}`) and sends confirmation/edits (`POST /api/v1/plans/{planId}/confirm`, `PATCH /api/v1/plans/{planId}`)</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/api/plans.py</path>
        <kind>FastAPI Router</kind>
        <symbol>GET /plans/{planId}, POST /plans/{planId}/confirm, PATCH /plans/{planId}</symbol>
        <lines></lines>
        <reason>Extends existing plans router with new endpoints</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/services/plans_service.py</path>
        <kind>Plan Service</kind>
        <symbol></symbol>
        <lines></lines>
        <reason>Extended to handle retrieval, confirmation, and editing of workout plans</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <name>Next.js</name>
        <version></version>
        <ecosystem>JS/TS</ecosystem>
      </dependency>
      <dependency>
        <name>Zustand</name>
        <version>5.0.9</version>
        <ecosystem>JS/TS</ecosystem>
      </dependency>
      <dependency>
        <name>Jest</name>
        <version>30.2.0</version>
        <ecosystem>JS/TS</ecosystem>
      </dependency>
      <dependency>
        <name>React Testing Library</name>
        <version>16.3.0</version>
        <ecosystem>JS/TS</ecosystem>
      </dependency>
      <dependency>
        <name>Playwright</name>
        <version>1.57.0</version>
        <ecosystem>JS/TS</ecosystem>
      </dependency>
      <dependency>
        <name>FastAPI</name>
        <version>0.123.7</version>
        <ecosystem>Python</ecosystem>
      </dependency>
      <dependency>
        <name>Supabase (PostgreSQL)</name>
        <version>2.86.0</version>
        <ecosystem>Database</ecosystem>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Frontend-Backend Contract: The structure of the fetched plan from `GET /plans/{planId}` and the confirmed plan data must match the agreed-upon API contract.</constraint>
    <constraint>Plan Editing: For this story, focus on display and confirmation; actual plan editing can be a separate story.</constraint>
    <constraint>UX/UI: Visual highlighting of adaptations should be clear and understandable.</constraint>
    <constraint>Backend testing issue persists; prioritize comprehensive frontend unit tests and E2E tests.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Get Plan API</name>
      <kind>REST endpoint</kind>
      <signature>GET /plans/{planId}</signature>
      <path>apps/api/app/api/plans.py</path>
    </interface>
    <interface>
      <name>Confirm Plan API</name>
      <kind>REST endpoint</kind>
      <signature>POST /plans/{planId}/confirm</signature>
      <path>apps/api/app/api/plans.py</path>
    </interface>
    <interface>
      <name>Edit Plan API</name>
      <kind>REST endpoint (potential)</kind>
      <signature>PATCH /plans/{planId}</signature>
      <path>apps/api/app/api/plans.py</path>
    </interface>
    <interface>
      <name>Supabase WorkoutPlans Table</name>
      <kind>Database Table</kind>
      <signature>Schema for structured JSON workout plans</signature>
      <path></path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend: Unit tests for `PlanReview` component, verifying rendering and display. Unit tests for Zustand store. Integration tests for fetching and confirmation logic, mocking API calls. E2E test for full user journey.
      Backend: Integration tests (Pytest) for new `GET /plans/{planId}` and `POST /plans/{planId}/confirm` endpoints.
    </standards>
    <locations>
      <location>apps/web/tests</location>
      <location>apps/api/tests</location>
    </locations>
    <ideas>
      <idea>Unit test `PlanReview` component for displaying plan details and adaptations correctly.</idea>
      <idea>Unit test `planReviewStore` for state management of plans and edits.</idea>
      <idea>Integration test fetching and confirmation logic, mocking API calls for `GET /plans/{planId}` and `POST /plans/{planId}/confirm`.</idea>
      <idea>E2E test a user reviewing a generated plan, confirming it, and verifying redirection.</idea>
      <idea>Integration test backend `GET /plans/{planId}` endpoint for correct plan retrieval.</idea>
      <idea>Integration test backend `POST /plans/{planId}/confirm` endpoint for updating plan status in the database.</idea>
    </ideas>
  </tests>
</story-context>
