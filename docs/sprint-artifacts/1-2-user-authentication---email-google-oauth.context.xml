<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>User Authentication - Email &amp; Google OAuth</title>
    <status>drafted</status>
    <generatedAt>2025-12-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-user-authentication---email-google-oauth.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a new user</asA>
    <iWant>to create an account or log in using my email/password or Google</iWant>
    <soThat>I can securely access the application</soThat>
<tasks>
-   [x] **Task 1: Implement Welcome/Authentication Gateway UI (AC: 1)**
    -   [x] Subtask 1.1: Create `WelcomeScreen.tsx`...
    -   [x] Subtask 1.2: Implement `Create Account`, `Log In`, `Continue with Google` buttons.
    -   [x] Subtask 1.3: Add navigation logic to corresponding authentication flows.
    -   [x] Subtask 1.4: Unit test `WelcomeScreen.tsx`...

-   [x] **Task 2: Implement Email Sign-up UI & Logic (AC: 2)**
    -   [x] Subtask 2.1: Create `EmailSignupForm.tsx`...
    -   [x] Subtask 2.2: Implement email and password input fields...
    -   [x] Subtask 2.3: Integrate with Supabase JS client...
    -   [x] Subtask 2.4: Handle successful registration...
    -   [x] Subtask 2.5: Unit test `EmailSignupForm.tsx`...

-   [x] **Task 3: Implement Email Login UI & Logic (AC: 3)**
    -   [x] Subtask 3.1: Create `EmailLoginForm.tsx`...
    -   [x] Subtask 3.2: Implement email and password input fields...
    -   [x] Subtask 3.3: Integrate with Supabase JS client...
    -   [x] Subtask 3.4: Handle successful login...
    -   [x] Subtask 3.5: Unit test `EmailLoginForm.tsx`...

-   [ ] **Task 4: Implement Google OAuth Flow (AC: 4, 5)**
    -   [ ] Subtask 4.1: ...
    ...
</tasks>
  </story>

  <acceptanceCriteria>
1.  The Welcome screen provides options for email/password and Google authentication (Flow 1, Screen 1 - `welcome_screen/code.html`).
2.  A new user can successfully register with a valid email and password using the Email Sign-up form (Flow 1, Screen 2A - `email_signup/code.html`).
3.  A returning user can successfully log in with a valid email and password using the Email Login form (Flow 1, Screen 2B - `email_authentication/code.html`).
4.  A user can successfully authenticate using their Google account via the Google OAuth flow (Flow 1, Screen 3).
5.  Upon successful authentication, new users are redirected to the Onboarding flow, and returning users are redirected to the Dashboard (Flow 1, Screen 4).
6.  All authentication is handled by Supabase Auth.
7.  User data is stored in the Supabase `Users` table.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Decision Summary</section>
        <snippet>This directly references ADR-003, which states the decision to use Supabase as the provider for both the PostgreSQL database and authentication. This is critical for the authentication flow in Story 1.2.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Details how authentication will be handled by Supabase Auth, authorization via Row Level Security (RLS), and how API keys and secrets will be managed via environment variables. This directly impacts the secure implementation of Story 1.2.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>Outlines the monorepo structure with Next.js frontend in `apps/web` and FastAPI backend in `apps/api`. This dictates where the code for Story 1.2 will reside and how frontend and backend interact.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 1.2: User Authentication - Email &amp; Google OAuth</section>
        <snippet>Provides the high-level user story, acceptance criteria, prerequisites (Story 1.1), and technical notes for Story 1.2. This forms the core requirements for the task.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/ux-design-phase1.md</path>
        <title>Phase 1 UX Design Specification</title>
        <section>Flow 1: Account Creation &amp; Authentication (Google â€¢ Email)</section>
        <snippet>Details the UX design for the authentication flow, including visual elements and interactions for the Welcome Screen, Email Sign-up, Email Login, and Google OAuth flow. Specific `code.html` references are provided for UI implementation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/api/tests/test_auth.py</path>
        <kind>test</kind>
        <symbol>Google OAuth callback placeholder</symbol>
        <lines>8-14</lines>
        <reason>Existing placeholder for Google OAuth callback test, indicates initial planning for backend test coverage.</reason>
      </artifact>
      <artifact>
        <path>apps/api/main.py</path>
        <kind>router import</kind>
        <symbol>auth.router</symbol>
        <lines>2-6</lines>
        <reason>Backend main application imports the `auth` router, indicating it's the entry point for authentication-related API calls.</reason>
      </artifact>
      <artifact>
        <path>apps/api/app/routes/auth.py</path>
        <kind>api endpoint</kind>
        <symbol>@router.get("/auth/google/callback")</symbol>
        <lines>5-13</lines>
        <reason>Placeholder backend endpoint for Google OAuth callback, needs to be implemented fully for this story.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/WelcomeScreen.tsx</path>
        <kind>component</kind>
        <symbol>WelcomeScreen</symbol>
        <lines>all</lines>
        <reason>Frontend component for the initial welcome/authentication gateway, where users choose their authentication method.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/EmailSignup.tsx</path>
        <kind>component</kind>
        <symbol>EmailSignup</symbol>
        <lines>all</lines>
        <reason>Frontend component for email registration, utilizes `supabase.auth.signUp`.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/EmailLogin.tsx</path>
        <kind>component</kind>
        <symbol>EmailLogin</symbol>
        <lines>all</lines>
        <reason>Frontend component for email login, utilizes `supabase.auth.signInWithPassword`.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/WelcomeScreen.test.tsx</path>
        <kind>test</kind>
        <symbol>WelcomeScreen tests</symbol>
        <lines>all</lines>
        <reason>Frontend unit test for the WelcomeScreen component.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/EmailSignup.test.tsx</path>
        <kind>test</kind>
        <symbol>EmailSignup tests</symbol>
        <lines>all</lines>
        <reason>Frontend unit test for the EmailSignup component.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/auth/EmailLogin.test.tsx</path>
        <kind>test</kind>
        <symbol>EmailLogin tests</symbol>
        <lines>all</lines>
        <reason>Frontend unit test for the EmailLogin component.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node/npm">
        <package name="@tailwindcss/container-queries" version="^0.1.1" type="devDependencies"/>
        <package name="@tailwindcss/forms" version="^0.5.10" type="devDependencies"/>
        <package name="rimraf" version="^6.1.2" type="devDependencies"/>
        <package name="typescript" version="^5" type="devDependencies"/>
        <package name="@supabase/supabase-js" version="^2.86.2" type="dependencies"/>
        <package name="next" version="16.0.7" type="dependencies"/>
        <package name="react" version="19.2.0" type="dependencies"/>
        <package name="react-dom" version="19.2.0" type="dependencies"/>
        <package name="@swc/jest" version="^0.2.39" type="devDependencies"/>
        <package name="@tailwindcss/postcss" version="^4" type="devDependencies"/>
        <package name="@testing-library/jest-dom" version="^6.9.1" type="devDependencies"/>
        <package name="@testing-library/react" version="^16.3.0" type="devDependencies"/>
        <package name="@types/jest" version="^30.0.0" type="devDependencies"/>
        <package name="@types/node" version="^20" type="devDependencies"/>
        <package name="@types/react" version="^19" type="devDependencies"/>
        <package name="@types/react-dom" version="^19" type="devDependencies"/>
        <package name="autoprefixer" version="^10.4.22" type="devDependencies"/>
        <package name="eslint" version="^9" type="devDependencies"/>
        <package name="eslint-config-next" version="16.0.7" type="devDependencies"/>
        <package name="jest" version="^30.2.0" type="devDependencies"/>
        <package name="jest-environment-jsdom" version="^30.2.0" type="devDependencies"/>
        <package name="playwright" version="^1.57.0" type="devDependencies"/>
        <package name="tailwindcss" version="^4" type="devDependencies"/>
        <package name="ts-jest" version="^29.4.6" type="devDependencies"/>
      </ecosystem>
      <ecosystem name="Python">
        <package name="fastapi"/>
        <package name="uvicorn[standard]"/>
        <package name="pytest"/>
      </ecosystem>
      <framework name="Next.js" version="16.0.7"/>
      <framework name="React" version="19.2.0"/>
      <framework name="Tailwind CSS"/>
      <framework name="FastAPI"/>
      <framework name="Supabase"/>
      <framework name="Jest" version="^30.2.0"/>
      <framework name="React Testing Library" version="^16.3.0"/>
      <framework name="Playwright" version="^1.57.0"/>
      <framework name="Pytest"/>
      <framework name="Zustand"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Monorepo structure: Frontend code in `apps/web` (Next.js, React, Tailwind, TypeScript), Backend code in `apps/api` (FastAPI, Python).</constraint>
    <constraint>Authentication must use Supabase Auth.</constraint>
    <constraint>Backend API endpoints for authentication must use Pydantic for request/response validation.</constraint>
    <constraint>JWTs must be handled securely for session management.</constraint>
    <constraint>Frontend state related to authentication should be managed with Zustand.</constraint>
    <constraint>Frontend unit tests with Jest/RTL, Backend integration tests with Pytest (addressing the `ModuleNotFoundError` if possible), E2E tests with Playwright.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /auth/register</name>
      <kind>REST endpoint</kind>
      <signature>Request: { "email": "string", "password": "string" }</signature>
      <path>apps/api/app/routes/auth.py</path>
    </interface>
    <interface>
      <name>POST /auth/login</name>
      <kind>REST endpoint</kind>
      <signature>Request: { "email": "string", "password": "string" }</signature>
      <path>apps/api/app/routes/auth.py</path>
    </interface>
    <interface>
      <name>GET /auth/google</name>
      <kind>REST endpoint (initiation)</kind>
      <signature>Initiates Google OAuth flow</signature>
      <path>apps/web/src/app/auth/WelcomeScreen.tsx</path>
    </interface>
    <interface>
      <name>GET /auth/google/callback</name>
      <kind>REST endpoint</kind>
      <signature>Handles Google OAuth callback</signature>
      <path>apps/api/app/routes/auth.py</path>
    </interface>
    <interface>
      <name>Supabase JS Client: `supabase.auth.signUp()`</name>
      <kind>function signature</kind>
      <signature>(AuthSignUpWithPasswordCredentials)</signature>
      <path>apps/web/src/app/auth/EmailSignup.tsx</path>
    </interface>
    <interface>
      <name>Supabase JS Client: `supabase.auth.signInWithPassword()`</name>
      <kind>function signature</kind>
      <signature>(AuthSignInWithPasswordCredentials)</signature>
      <path>apps/web/src/app/auth/EmailLogin.tsx</path>
    </interface>
    <interface>
      <name>Supabase JS Client: `supabase.auth.signInWithOAuth()`</name>
      <kind>function signature</kind>
      <signature>(Provider)</signature>
      <path>apps/web/src/app/auth/WelcomeScreen.tsx</path>
    </interface>
    <interface>
      <name>Zustand Auth Store</name>
      <kind>global state management</kind>
      <signature>Manages user object, JWT, loading status</signature>
      <path>apps/web/src/store/auth.ts (to be created)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      <standard>Frontend unit/integration tests using Jest and React Testing Library.</standard>
      <standard>Backend integration tests using Pytest (note: previous story identified a `ModuleNotFoundError` with Pytest, which needs to be addressed).</standard>
      <standard>End-to-end tests using Playwright for full user journeys.</standard>
    </standards>
    <locations>
      <location>apps/web/src/app/auth/*.test.tsx</location>
      <location>apps/api/tests/*.py</location>
      <location>tests/e2e/</location>
    </locations>
    <ideas>
      <idea acId="1">E2E test `WelcomeScreen` for proper rendering of authentication options and correct navigation upon button clicks.</idea>
      <idea acId="2">Unit/Integration test `EmailSignupForm` to verify user registration with valid/invalid credentials and error handling, including redirection to onboarding.</idea>
      <idea acId="3">Unit/Integration test `EmailLoginForm` for user login with valid/invalid credentials, error handling, and redirection to dashboard.</idea>
      <idea acId="4">E2E test the Google OAuth flow using Playwright, mocking external calls, to verify successful authentication and correct redirection.</idea>
      <idea acId="5">E2E test the redirection logic after both email/password and Google OAuth authentication, ensuring new users go to onboarding and returning users go to the dashboard.</idea>
      <idea acId="6">Integration test the Supabase Auth backend service (`auth_service.py`) to confirm correct interaction with Supabase for user creation, login, and token management.</idea>
      <idea acId="7">Integration test to verify user data is correctly stored and updated in the Supabase `Users` table upon registration and login.</idea>
      <idea acId="6.3">Integration test `User` data persistence and redirection logic after authentication.</idea>
    </ideas>
  </tests>
</story-context>
