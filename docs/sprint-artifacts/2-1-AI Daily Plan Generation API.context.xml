<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>AI Daily Plan Generation API</title>
    <status>drafted</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>C:\Users\Administrator\SG-Gruppe-KI\docs\sprint-artifacts\2-1-ai-daily-plan-generation-api.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend service</asA>
    <iWant>to expose an API endpoint that generates a structured daily workout plan based on user profile, historical data, and contextual inputs, including simulated recovery</iWant>
    <soThat>the frontend can display a personalized plan.</soThat>
    <tasks></tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">The FastAPI backend exposes a `POST /plans/generate` API endpoint.</criterion>
    <criterion id="2">A `POST` request to `/plans/generate` with valid `userId`, `goals`, `equipment`, `historicalData`, and `context` (including `recovery_bias` and simulated HRV/sleep) is successfully processed.</criterion>
    <criterion id="3">The AI Orchestrator service correctly constructs a prompt for the AI model based on the provided inputs.</criterion>
    <criterion id="4">The AI model (OpenAI API) generates a structured JSON workout plan.</criterion>
    <criterion id="5">The API response includes the structured JSON workout plan and an explanation for plan adaptations based on the context.</criterion>
    <criterion id="6">The `p95` API latency for AI-related processing of this endpoint is ≤ 10s.</criterion>
    <criterion id="7">The generated plan is successfully stored in the `WorkoutPlans` database table in Supabase.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (API Pattern)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | API Pattern | FastAPI | 0.123.7 | AI Planning, Workout Logging, All Backend Services | Recommended in proposal; Excellent for AI/ML integration and high performance. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Decision Summary (Data Persistence)</title>
        <section>Decision Summary</section>
        <snippet>
          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | Data Persistence | Supabase (PostgreSQL) | 2.86.0 | All data-related features | Provides a managed PostgreSQL database, simplifying setup and scaling. Also includes Auth and Storage. |
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Project Initialization (FastAPI)</title>
        <section>Project Initialization</section>
        <snippet>
          ## Project Initialization

          ...

          We will work through the following decisions together:

          1.  **Backend Framework:** The engine that will power your AI features.
          ...

          ## Decision Summary

          | Category | Decision | Version | Affects Epics | Rationale |
          | -------- | -------- | ------- | ------------- | --------- |
          | API Pattern | FastAPI | 0.123.7 | AI Planning, Workout Logging, All Backend Services | Recommended in proposal; Excellent for AI/ML integration and high performance. |
          ...
          ## Project Structure

          The project will be a monorepo containing two main packages: one for the Next.js frontend and one for the FastAPI backend.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Backend (FastAPI) for AI Integration</title>
        <section>FR Category to Architecture Mapping</section>
        <snippet>
          -   **Backend (FastAPI `api` app):** Responsible for all business logic, data processing, and AI integration.
              -   Handles: AI Daily-Plan Generation, Workout Log storage/retrieval, User Authentication logic, Spotify API communication.
              -   Interacts directly with the Supabase (PostgreSQL) database.
              -   Provides the REST API for the frontend.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Security Architecture (Input Validation)</title>
        <section>Security Architecture</section>
        <snippet>
          -   **Input Validation:** All incoming data to the API will be validated using **Pydantic** models in FastAPI.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture - Novel Architectural Patterns (Adaptive Workout Dialogue)</title>
        <section>Novel Architectural Patterns</section>
        <snippet>
          ### Pattern: Adaptive Workout Dialogue

          This pattern formalizes the conversational loop between the user and the AI, ensuring the AI's adaptations are transparent, effective, and continuously learning.

          **Purpose:** To move beyond static plan generation and create a dynamic, two-way conversation where the user's daily context directly and transparently shapes their workout.

          **Components:**
          1.  **Context Window (Frontend):** The UI where the user inputs their daily qualitative feedback (mood, energy, soreness, etc.).
          2.  **AI Orchestrator (Backend):** A service in the FastAPI backend that receives the user's context, fuses it with their profile and history, and constructs the prompt for the AI model.
          3.  **AI Model (OpenAI API):** The external Large Language Model that generates the workout plan and adaptation suggestions.
          4.  **Plan Review UI (Frontend):** The screen where the user sees the proposed (and potentially modified) plan and the AI's reasoning.
          5.  **Feedback Loop (Backend):** A mechanism to store the user's acceptance or rejection of suggestions, feeding that data back into future prompts.

          **Data Flow:**
          1.  User submits context (e.g., "Feeling low energy") via the **Context Window**.
          2.  The **AI Orchestrator** combines this with recent workout data and goals, then sends a detailed prompt to the **AI Model**.
          3.  The **AI Model** returns a structured JSON plan *and* a human-readable explanation for any changes (e.g., "Because you're low on energy, I've reduced volume by 10%...").
          4.  The **Plan Review UI** displays both the adjusted plan and the AI's explanation.
          5.  If the user accepts, the plan is confirmed. If they edit or reject a change, this feedback is captured by the **Feedback Loop** to refine future suggestions.

          This pattern is critical for making the AI feel like a true, listening companion.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/ux-design-direction.md</path>
        <title>UX Design Direction - Flow 6: Generate AI Daily Plan</title>
        <section>Flow 6: Generate AI Daily Plan</section>
        <snippet>
          ### **Flow 6: Generate AI Daily Plan**

          *   **Purpose:** Enable users to provide real-time context to the AI and receive an adaptive, personalized workout plan.
          *   **Core User Journey:** User accesses a "Context Window," inputs their current state (mood, energy) with smart suggestions. AI generates a plan, which is presented for review and optional adjustment before confirmation.
          *   **Key UX Direction / Improvements:**
              *   **Smart Context Window:** Pre-fills suggestions based on historical patterns and contextual prompts (e.g., "how are your legs feeling after yesterday's workout?").
              *   **Transparent Plan Changes:** Visually highlights and explains *why* the AI adapted the plan based on user context, fostering trust.
              *   **"Edit Plan" Option:** Provides users with the ability to make granular adjustments to the AI's proposed plan before confirmation, ensuring final control.
        </snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic 2, Story 2.1: AI Daily Plan Generation API</title>
        <section>Epic 2: AI-Powered Training & Logging</section>
        <snippet>
          ### Story 2.1: AI Daily Plan Generation API
          As a backend service,
          I want to expose an API endpoint that generates a structured daily workout plan based on user profile, historical data, and contextual inputs, including simulated recovery,
          So that the frontend can display a personalized plan.

          **Acceptance Criteria:**
          Given the FastAPI backend is running
          When a POST request is made to `/plans/generate` with `userId`, `goals`, `equipment`, `historicalData`, and `context` (including `recovery_bias` and simulated HRV/sleep)
          Then the AI Orchestrator service constructs a prompt for the AI model
          And the AI model (OpenAI API) generates a structured JSON workout plan
          And the response includes an explanation for plan adaptations based on context
          And `p95` API latency for non-AI components is < 300ms, and for AI is ≤ 10s
          And the plan is stored in the `WorkoutPlans` database table

          **Prerequisites:** Story 1.1, 1.3. FastAPI setup from `architecture_content`.

          **Technical Notes:** Implement `/plans/generate` endpoint in FastAPI. Integrate with OpenAI API. Use Pydantic for request/response validation. Implement `AI Orchestrator` logic to fuse inputs and construct prompts. Store plans in Supabase `WorkoutPlans` table. Implement `NFR004` (Performance) and `NFR009` (Rate Limiting) for this endpoint.
        </snippet>
      </artifact>
    </docs>
    <code></code>
    <dependencies></dependencies>
  </artifacts>

  <constraints></constraints>
  <interfaces></interfaces>
  <tests>
    <standards></standards>
    <locations></locations>
    <ideas></ideas>
  </tests>
</story-context>
