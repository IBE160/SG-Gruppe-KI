<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.5</storyId>
    <title>Offline Cache for Daily Plans and Logs</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-5-offline-cache-for-daily-plans-and-logs.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to access my daily workout plan and log my progress even when offline</iWant>
    <soThat>my training is not interrupted by connectivity issues</soThat>
    <tasks>
      - [ ] **Task 1: Frontend Offline Module** (AC: #1, #2)
        - [ ] Implement an `Offline Module` to manage IndexedDB for local caching of daily plans and logs.
        - [ ] Implement client-side logic to store daily plans in IndexedDB when loaded online.
        - [ ] Implement client-side logic to load daily plans from IndexedDB when offline.
        - [ ] Integrate with the Workout Player to store logged sets in IndexedDB when offline using the Outbox Pattern.
      - [ ] **Task 2: Backend Offline Sync Service** (AC: #2)
        - [ ] Create an `Offline Sync Service` (`app/services/offline_sync_service.py`) to process data from the Outbox Pattern. (Source: `tech-spec-epic-3.md#Services-and-Modules`)
        - [ ] Create a `POST /api/v1/offline_sync/workout_logs` endpoint to receive batched workout logs from the offline client. (Source: `tech-spec-epic-3.md#APIs-and-Interfaces`)
        - [ ] Implement logic to persist the received data to the `workout_logs` table.
      - [ ] **Task 3: Testing** (AC: #1, #2)
        - [ ] Add React Testing Library tests for the Offline Module's caching and data retrieval logic.
        - [ ] Add Pytest integration tests for the `Offline Sync Service` and its endpoint.
        - [ ] Add Playwright E2E tests for offline scenarios, including:
          - Loading a plan online, going offline, viewing the plan, logging sets offline.
          - Reconnecting to the network and verifying that offline logs are synced to the backend.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** a user has loaded their daily plan while online, **when** they go offline, **then** they can still view their daily plan and log sets.
    2.  **And** logged data is stored locally and synced to the backend upon reconnection.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 3.5: Offline Cache for Daily Plans and Logs</section>
        <snippet>As a User, I want to access my daily workout plan and log my progress even when offline, so that my training is not interrupted by connectivity issues.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>Services and Modules</section>
        <snippet>Offline Module: Manages IndexedDB for local caching and synchronizes data with backend using Outbox Pattern.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Enhanced User Experience &amp; Settings</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/offline_sync/workout_logs: Endpoint to receive batched workout logs from offline client.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Offline Data Synchronization with Outbox Pattern</section>
        <snippet>To support offline workout logging and plan access (NFR007), the application will implement an Offline Data Synchronization pattern utilizing IndexedDB on the client-side and an Outbox Pattern.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/services/offline_sync_service.py</path>
        <kind>service</kind>
        <symbol>OfflineSyncService</symbol>
        <lines></lines>
        <reason>This new service will process and persist data from the Outbox Pattern.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/api/v1/offline_sync.py</path>
        <kind>api</kind>
        <symbol>POST /api/v1/offline_sync/workout_logs</symbol>
        <lines></lines>
        <reason>This new file will contain the API endpoint for receiving offline workout logs.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="pydantic" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
      </ecosystem>
      <ecosystem name="Node">
        <dependency name="indexeddb" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use IndexedDB for local caching of daily plans and logs.</constraint>
    <constraint>Must implement the Outbox Pattern for reliable synchronization of offline data.</constraint>
    <constraint>Data integrity and consistency must be maintained during offline operations and synchronization.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Sync Offline Workout Logs</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/offline_sync/workout_logs</signature>
      <path>backend/app/api/v1/offline_sync.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Frontend tests should use React Testing Library. Backend integration tests should use Pytest. End-to-end tests for offline scenarios should use Playwright.
    </standards>
    <locations>
      <location type="Frontend">Component-colocated tests or a central /app/tests/ directory.</location>
      <location type="Backend">/backend/tests/</location>
      <location type="E2E">/tests/e2e/</location>
    </locations>
    <ideas>
      <idea ac_id="1">Write component tests for the Offline Module's caching and retrieval logic.</idea>
      <idea ac_id="2">Write integration tests for the `Offline Sync Service` endpoint, verifying data persistence.</idea>
      <idea ac_id="1, 2">Write E2E tests for offline scenarios, including logging workouts offline and verifying successful synchronization upon reconnection.</idea>
    </ideas>
  </tests>
</story-context>
