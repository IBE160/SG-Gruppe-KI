<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.2</storyId>
    <title>AI Daily Plan Generation</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-ai-daily-plan-generation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>the AI to generate a personalized daily workout plan based on my goals, profile, and daily context</iWant>
    <soThat>I have a clear plan to follow</soThat>
    <tasks>
      - [ ] **Task 1: Backend API for Plan Generation** (AC: #1, #2)
        - [ ] Create a `POST /api/v1/workout_plans/generate` endpoint in FastAPI to trigger plan generation. (Source: `tech-spec-epic-2.md#APIs-and-Interfaces`)
        - [ ] Implement the `AI Plan Generation Service` to orchestrate data fetching (user profile, daily context, workout history). (Source: `tech-spec-epic-2.md#Services-and-Modules`)
        - [ ] Construct a prompt for the OpenAI API using relevant user data.
        - [ ] Implement logic to call the OpenAI API.
        - [ ] Validate OpenAI's JSON response against the defined schema (`Architecture.md`).
        - [ ] Save the valid `plan_json` to the `workout_plans` table.
        - [ ] Implement AI Response Caching using Redis. (Source: `tech-spec-epic-2.md#Services-and-Modules`)
      - [ ] **Task 2: Data Model &amp; Schema Verification** (AC: #2)
        - [ ] Verify the `workout_plans` table schema in Supabase (`id`, `user_id`, `plan_date`, `plan_json`, `status`). (Source: `tech-spec-epic-2.md#Data-Models-and-Contracts`)
        - [ ] Verify the `AI Workout Plan JSON Structure` defined in `Architecture.md`.
      - [ ] **Task 3: Testing** (AC: #1, #2)
        - [ ] Add Pytest integration tests for the `POST /api/v1/workout_plans/generate` endpoint, mocking OpenAI API calls.
        - [ ] Test prompt construction and data extraction.
        - [ ] Test JSON schema validation of the AI response.
        - [ ] Test AI Response Caching functionality.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** a user has provided their daily context, **when** they request a new plan for the day, **then** the FastAPI backend constructs a prompt with the user's profile, daily context, and recent workout history.
    2.  **And** the AI returns a valid JSON workout plan which is then saved to the `workout_plans` table.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 2.2: AI Daily Plan Generation</section>
        <snippet>As a User, I want the AI to generate a personalized daily workout plan based on my goals, profile, and daily context, so that I have a clear plan to follow.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Training &amp; Logging</title>
        <section>Services and Modules</section>
        <snippet>AI Plan Generation Service (`app/services/ai_plan_service.py`): Orchestrates data fetching (user profile, daily context, workout history), constructs prompts, calls OpenAI API, validates response, and stores `plan_json` in `workout_plans` table. Utilizes AI Response Cache (Redis).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Training &amp; Logging</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/workout_plans/generate</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>AI Integration and Prompting</section>
        <snippet>The OpenAI GPT model functions as the core intelligence for personalized plan generation. Its primary roles are: Generate Daily Workout Plans, Adapt Existing Plans, and Future Capabilities.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/services/ai_plan_service.py</path>
        <kind>service</kind>
        <symbol>AIPlanService</symbol>
        <lines></lines>
        <reason>This new service will contain the core logic for generating AI workout plans.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/api/v1/workout_plans.py</path>
        <kind>api</kind>
        <symbol>POST /api/v1/workout_plans/generate</symbol>
        <lines></lines>
        <reason>This new file will contain the API endpoint for triggering AI plan generation.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/schemas/workout_plan.py</path>
        <kind>schema</kind>
        <symbol>WorkoutPlan</symbol>
        <lines></lines>
        <reason>This new file will contain the Pydantic schema for the workout plan.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="uvicorn" version="" type="runtime" />
        <dependency name="python-dotenv" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
        <dependency name="openai" version="" type="runtime" />
        <dependency name="redis" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>The JSON response from OpenAI must be validated against the defined schema in `architecture.md`.</constraint>
    <constraint>AI Response Caching must be implemented using Redis.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Generate AI Workout Plan</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/workout_plans/generate</signature>
      <path>backend/app/api/v1/workout_plans.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit tests should be written with Pytest. Integration tests should mock external services like the OpenAI API.
    </standards>
    <locations>
      <location type="Backend">/backend/tests/</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">Write an integration test for the `POST /api/v1/workout_plans/generate` endpoint, mocking OpenAI API calls.</idea>
      <idea ac_id="1">Test prompt construction with various user data.</idea>
      <idea ac_id="2">Test JSON schema validation of the AI response.</idea>
      <idea ac_id="1, 2">Test AI Response Caching functionality with Redis.</idea>
    </ideas>
  </tests>
</story-context>
