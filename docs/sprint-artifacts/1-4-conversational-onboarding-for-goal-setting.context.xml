<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.4</storyId>
    <title>Conversational Onboarding for Goal Setting</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-conversational-onboarding-for-goal-setting.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new User</asA>
    <iWant>to be guided through a conversational onboarding process</iWant>
    <soThat>I can set up my initial fitness goals, preferences, and available equipment</soThat>
    <tasks>
        - [ ] **Task 1: Backend API for Onboarding Data** (AC: #4)
            - [ ] Create `POST /api/v1/users/onboarding` endpoint to handle saving initial onboarding data to the `users` table. (Source: `tech-spec-epic-1.md#APIs-and-Interfaces`)
            - [ ] Implement validation for the incoming onboarding data.
        - [ ] **Task 2: Frontend Onboarding UI** (AC: #1, #2, #3, #4)
            - [ ] Create a multi-step UI component for the conversational onboarding flow.
            - [ ] Implement logic to redirect new users to this flow after initial login.
            - [ ] Design and implement the UI for questions regarding goals, time availability, equipment, injuries, and preferred units.
            - [ ] Implement client-side logic to send collected data to the backend `/api/v1/users/onboarding` endpoint.
        - [ ] **Task 3: Data Model Updates**
            - [ ] Ensure the `users` table schema in Supabase can store `goals` (JSONB), `preferences` (JSONB), `equipment` (TEXT[]), `injuries` (TEXT), and `units` (TEXT). (Source: `tech-spec-epic-1.md#Data-Models-and-Contracts`)
        - [ ] **Task 4: Testing**
            - [ ] Add Pytest integration tests for the new backend onboarding endpoint.
            - [ ] Add Playwright E2E tests to cover the full onboarding flow, ensuring data is correctly saved.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** a new user logs in for the first time
    2.  **When** they are redirected to the onboarding flow
    3.  **Then** they are presented with a series of questions about their goals, time availability, equipment, injuries, and preferred units.
    4.  **And** their responses are saved to their user profile in the `users` table.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 1.4: Conversational Onboarding for Goal Setting</section>
        <snippet>As a new User, I want to be guided through a conversational onboarding process, So that I can set up my initial fitness goals, preferences, and available equipment.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Core Platform & User Foundation</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/users/onboarding</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Data Architecture</section>
        <snippet>The `users` table will store goals (JSONB), preferences (JSONB), equipment (TEXT[]), injuries (TEXT), and units (TEXT).</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code artifacts found relevant to this story. This story will create the onboarding API endpoint and frontend module. -->
    </code>
    <dependencies>
      <ecosystem name="Node">
        <dependency name="@faker-js/faker" version="^10.1.0" type="dev" />
        <dependency name="@playwright/test" version="^1.56.1" type="dev" />
      </ecosystem>
      <ecosystem name="Python">
        <!-- No requirements.txt or pyproject.toml found. Dependencies are defined in architecture documents. -->
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="uvicorn" version="" type="runtime" />
        <dependency name="python-dotenv" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>Onboarding data must be persisted in the Supabase `users` table, in the appropriate columns (goals, preferences, etc.).</constraint>
    <constraint>The implementation should be added to the existing `users` API in `app/api/v1/users.py` and a new frontend module.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Save Onboarding Data</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/users/onboarding</signature>
      <path>backend/app/api/v1/users.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit tests should be written with Pytest. Frontend component tests should use React Testing Library. End-to-end tests for user flows should be implemented with Playwright.
    </standards>
    <locations>
      <location type="E2E">/tests/e2e/</location>
      <location type="Backend">/backend/tests/</location>
      <location type="Frontend">Component-colocated tests or a central /app/tests/ directory.</location>
    </locations>
    <ideas>
      <idea ac_id="4">Write an integration test for the `POST /api/v1/users/onboarding` endpoint, testing with valid and invalid data.</idea>
      <idea ac_id="1, 2, 3, 4">Write a full E2E test using Playwright that simulates a new user logging in for the first time, completing the multi-step onboarding flow, and verifying that the data is correctly saved to the user's profile.</idea>
    </ideas>
  </tests>
</story-context>
