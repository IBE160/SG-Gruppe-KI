<story-context id="3-1-spotify-integration-oauth" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Spotify Integration & OAuth</title>
    <status>drafted</status>
    <generatedAt>2025-12-15</generatedAt>
    <generator>BMAD Story Context Workflow (Regenerated)</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-Spotify Integration & OAuth.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>user</asA>
    <iWant>to securely connect my Spotify account to the app</iWant>
    <soThat>I can enable AI-powered music features for my workouts.</soThat>
    <tasks>
      - [ ] **Task 1: Backend Spotify OAuth Endpoints & Service**
      - [ ] **Task 2: Frontend Spotify Connect UI & Logic**
      - [ ] **Task 3: Supabase `Integrations` Table Setup**
      - [ ] **Task 4: E2E Testing**
    </tasks>
  </story>
  <acceptanceCriteria>
    <criterion>AC3.1.1: A user is redirected to the Spotify OAuth consent screen when they choose to connect their account.</criterion>
    <criterion>AC3.1.2: After granting permissions, the user is redirected back to the app, and the connection status is confirmed.</criterion>
    <criterion>AC3.1.3: Spotify access and refresh tokens are securely stored in the `Integrations` table.</criterion>
  </acceptanceCriteria>
  <artifacts>
    <docs>
        <doc>
            <path>docs/architecture.md</path>
            <title>Architecture</title>
            <section>Decision Summary</section>
            <snippet>Key decisions: API Pattern: FastAPI, Data Persistence: Supabase, Authentication: Supabase Auth...</snippet>
        </doc>
        <doc>
            <path>docs/ux-design-direction.md</path>
            <title>UX Design Direction</title>
            <section>Flow 3: Connect Spotify (Optional Music Integration)</section>
            <snippet>The UI for the Spotify connection flow should be based on Flow 3, Screen 1...</snippet>
        </doc>
    </docs>
    <code>
      <!-- No existing code artifacts found relevant to this story. -->
    </code>
  </artifacts>
  <constraints>
    <constraint>Spotify access_token and refresh_token MUST be encrypted at rest in the Integrations table.</constraint>
    <constraint>Tokens MUST NOT be exposed to the client-side application after the initial OAuth callback; all Spotify API requests must be proxied through the FastAPI backend.</constraint>
  </constraints>
  <interfaces>
      <interface>
        <name>Spotify Connect</name>
        <kind>REST Endpoint</kind>
        <signature>GET /music/connect/spotify</signature>
        <path>apps/api/app/api/music.py</path>
      </interface>
      <interface>
        <name>Spotify Callback</name>
        <kind>REST Endpoint</kind>
        <signature>GET /music/callback/spotify</signature>
        <path>apps/api/app/api/music.py</path>
      </interface>
  </interfaces>
  <tests>
      <standards>Frontend (Jest/RTL), Backend (Pytest), E2E (Playwright - with mocked OAuth redirects).</standards>
      <locations><location>apps/api/tests/music/</location></locations>
      <ideas>
          <idea>Integration test backend OAuth endpoints, mocking Spotify API calls and token encryption.</idea>
          <idea>E2E test the full Spotify OAuth connection flow, mocking external redirects and verifying token storage.</idea>
      </ideas>
  </tests>
</story-context>