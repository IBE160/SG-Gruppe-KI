<story-context id="3-2-ai-driven-session-mix-generation" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>AI-Driven Session Mix Generation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-15</generatedAt>
    <generator>BMAD Story Context Workflow (Regenerated)</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-AI-Driven Session Mix Generation.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>user with a connected Spotify account</asA>
    <iWant>the AI to generate personalized, phase-aligned workout playlists ("Session Mix")</iWant>
    <soThat>my music enhances my training experience.</soThat>
    <tasks>
      - Frontend (apps/web):
        - UI Implementation (Flow 11, Screen 1): Create React components for "Generate Session Mix" initiation, including mix type selection.
        - UI Implementation (Flow 11, Screen 2): Create React components for "Session Mix Preview & Customization," including tracklist display, seed input for artists/genres, and track review/customization.
        - API Integration: Implement client-side API calls to the FastAPI backend for generating the session mix and handling user customizations.
        - State Management: Use Zustand to manage frontend state for mix generation, preview, and customization.
        - Testing: Write unit tests, integration tests, and Playwright E2E tests.
      - Backend (apps/api):
        - API Endpoints: Create `/music/generate-session-mix` endpoint and Spotify API interaction endpoints.
        - AI Music Scorer Logic: Implement core AI logic for playlist generation.
        - Spotify API Integration: Implement secure interactions with the Spotify API.
        - Data Persistence: Define and implement the `MusicPreferences` model.
        - Testing: Write unit tests and integration tests.
      - Data Model: Define `MusicPreferences` table structure.
      - Documentation: Update API documentation, add comments.
      - Refinement: Ensure API communication adheres to standard format, implement structured logging, verify naming conventions.
    </tasks>
  </story>
  <acceptanceCriteria>
    <criterion>AC3.2.1: A user is presented with a "Generate Session Mix" screen where they can select the mix type.</criterion>
    <criterion>AC3.2.2: The AI Music Scorer (backend) generates a playlist based on BPM, audio features, listening history, and user feedback.</criterion>
    <criterion>AC3.2.3: The user is presented with a "Session Mix Preview & Customization" screen where they can review and customize individual tracks.</criterion>
  </acceptanceCriteria>
  <artifacts>
    <docs>
        <doc>
            <path>docs/architecture.md</path>
            <title>Architecture</title>
            <section>Novel Architectural Patterns</section>
            <snippet>Pattern: AI-Driven Music Matching ("Smart Radio") - This pattern defines a system that learns from user behavior to create personalized, phase-aware workout playlists...</snippet>
        </doc>
        <doc>
            <path>docs/ux-design-direction.md</path>
            <title>UX Design Direction</title>
            <section>Flow 11: Generate Session Mix (Optional AI-Based Playlist)</section>
            <snippet>This screen allows users to preview the AI-generated session mix, select a playlist mode, seed the mix with artists/genres, and review/customize the individual tracks...</snippet>
        </doc>
    </docs>
    <code>
      <!-- No existing code artifacts found relevant to this story. -->
    </code>
  </artifacts>
  <constraints>
    <constraint>All external API calls must be proxied through the FastAPI backend to ensure token security.</constraint>
    <constraint>AI Music Scorer must continuously re-rank tracks based on user feedback, ensuring playlists get smarter over time.</constraint>
  </constraints>
  <interfaces>
      <interface>
        <name>Generate Session Mix</name>
        <kind>REST Endpoint</kind>
        <signature>POST /music/generate-session-mix</signature>
        <path>apps/api/app/api/music.py</path>
      </interface>
  </interfaces>
  <tests>
      <standards>Frontend unit tests (Jest/React Testing Library), backend unit tests for AI Music Scorer logic, integration tests for API endpoints, and E2E tests (Playwright) for the entire Flow 11 user journey.</standards>
      <locations><location>apps/web/src/app/music/mix/</location></locations>
      <ideas>
          <idea>Unit test frontend components for mix type selection and customization.</idea>
          <idea>Integration test `POST /music/generate-session-mix` with mocked Spotify API and AI Music Scorer logic.</idea>
          <idea>E2E test the full Flow 11 user journey, verifying playlist generation, customization, and integration with Spotify.</idea>
      </ideas>
  </tests>
</story-context>