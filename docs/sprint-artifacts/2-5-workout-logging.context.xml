<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.5</storyId>
    <title>Workout Logging</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-workout-logging.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to log my completed reps, weight, and RPE for each set</iWant>
    <soThat>my progress can be tracked</soThat>
    <tasks>
      - [ ] **Task 1: Frontend UI for Workout Logging** (AC: #1)
        - [ ] Implement input fields in the Workout Player UI for reps, weight, and RPE.
        - [ ] Implement logic to capture and store the logged data locally (e.g., in component state or a state management solution).
        - [ ] On set completion, trigger the data submission process.
      - [ ] **Task 2: Backend API for Workout Logging** (AC: #2)
        - [ ] Create a `POST /api/v1/workout_logs` endpoint in FastAPI to receive and persist workout log data. (Source: `tech-spec-epic-2.md#APIs-and-Interfaces`)
        - [ ] Implement logic to save the log data to the `workout_logs` table in Supabase.
        - [ ] Implement Pydantic schemas for request validation.
      - [ ] **Task 3: Data Model &amp; Schema Verification** (AC: #2)
        - [ ] Verify the `workout_logs` table schema in Supabase (`id`, `user_id`, `workout_plan_id`, `exercise_name`, `set_number`, `reps_completed`, `weight_used`, `rpe_logged`, `log_time`). (Source: `tech-spec-epic-2.md#Data-Models-and-Contracts`)
      - [ ] **Task 4: Offline Synchronization** (AC: #1, #2)
        - [ ] Integrate the frontend logging mechanism with the IndexedDB and Outbox Pattern established in the previous story.
        - [ ] Ensure that logs created while offline are queued and synced with the backend when connectivity is restored.
      - [ ] **Task 5: Testing** (AC: #1, #2)
        - [ ] Add Pytest integration tests for the `POST /api/v1/workout_logs` endpoint.
        - [ ] Add React Testing Library tests for the workout logging input components.
        - [ ] Add Playwright E2E tests for logging a set, both online and offline.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** a user is in the workout player, **when** they complete a set, **then** they can input the reps, weight, and RPE.
    2.  **And** this data is saved to the `workout_logs` table.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 2.5: Workout Logging</section>
        <snippet>As a User, I want to log my completed reps, weight, and RPE for each set, so that my progress can be tracked.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Training &amp; Logging</title>
        <section>APIs and Interfaces</section>
        <snippet>POST /api/v1/workout_logs: Logs a single set of an exercise.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: AI-Powered Training &amp; Logging</title>
        <section>Data Models and Contracts</section>
        <snippet>`workout_logs` table: `id`, `user_id`, `workout_plan_id`, `exercise_name`, `set_number`, `reps_completed`, `weight_used`, `rpe_logged`, `log_time`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Offline Data Synchronization with Outbox Pattern</section>
        <snippet>To support offline workout logging and plan access (NFR007), the application will implement an Offline Data Synchronization pattern utilizing IndexedDB on the client-side and an Outbox Pattern.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/api/v1/workout_logs.py</path>
        <kind>api</kind>
        <symbol>POST /api/v1/workout_logs</symbol>
        <lines></lines>
        <reason>This new file will contain the API endpoint for persisting workout log data.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/schemas/workout_log.py</path>
        <kind>schema</kind>
        <symbol>WorkoutLogCreate</symbol>
        <lines></lines>
        <reason>This new file will contain the Pydantic schema for validating workout log data.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Node">
        <dependency name="idb" version="" type="runtime" />
      </ecosystem>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="pydantic" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>Must handle offline logging of workout data using IndexedDB.</constraint>
    <constraint>Must implement the Outbox Pattern for syncing offline data.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Log Workout Set</name>
      <kind>REST Endpoint</kind>
      <signature>POST /api/v1/workout_logs</signature>
      <path>backend/app/api/v1/workout_logs.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit tests should be written with Pytest. Frontend component tests should use React Testing Library. End-to-end tests for user flows should be implemented with Playwright, with a specific focus on offline scenarios.
    </standards>
    <locations>
      <location type="E2E">/tests/e2e/</location>
      <location type="Backend">/backend/tests/</location>
      <location type="Frontend">Component-colocated tests or a central /app/tests/ directory.</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">Write an integration test for the `POST /api/v1/workout_logs` endpoint.</idea>
      <idea ac_id="1">Write a UI component test for the logging inputs within the Workout Player.</idea>
      <idea ac_id="1, 2">Write a full E2E test for logging a set, including an offline-to-online synchronization scenario.</idea>
    </ideas>
  </tests>
</story-context>
