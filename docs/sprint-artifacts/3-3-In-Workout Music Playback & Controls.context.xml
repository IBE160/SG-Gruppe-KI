<story-context id="3-3-in-workout-music-playback-controls" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3</storyId>
    <title>In-Workout Music Playback & Controls</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-15</generatedAt>
    <generator>BMAD Story Context Workflow (Regenerated)</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-3-In-Workout Music Playback & Controls.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>user</asA>
    <iWant>to control music playback and receive visual feedback on BPM matching during my workout</iWant>
    <soThat>I can maintain focus and optimize my performance.</soThat>
    <tasks>
      - Frontend (apps/web):
        - UI Integration: Integrate music playback controls into the Workout Player UI (Flow 9).
        - Visual Feedback: Implement visual feedback on BPM matching.
        - Spotify SDK Integration: Integrate Spotify Web Playback SDK.
        - API Integration: Implement client-side API calls to log user music interactions.
        - Testing: Write unit tests, integration tests, and Playwright E2E tests.
      - Backend (apps/api):
        - API Endpoint: Create `/music/feedback` endpoint to receive and log user music interactions.
        - Music Interaction Logging: Store logged user interactions in the database.
        - Testing: Write unit tests and integration tests.
      - Refinement: Ensure API communication adheres to standard format, implement structured logging, verify naming conventions.
    </tasks>
  </story>
  <acceptanceCriteria>
    <criterion>AC3.3.1: Music playback controls (play/pause, skip, volume) are available and functional within the Workout Player UI.</criterion>
    <criterion>AC3.3.2: Visual feedback on BPM matching for the current workout phase is displayed.</criterion>
    <criterion>AC3.3.3: User music interactions (skips, completions) are logged via the backend to refine future AI scoring.</criterion>
  </acceptanceCriteria>
  <artifacts>
    <docs>
        <doc>
            <path>docs/architecture.md</path>
            <title>Architecture</title>
            <section>Novel Architectural Patterns</section>
            <snippet>Pattern: AI-Driven Music Matching ("Smart Radio") - Specifically, the "Playback Feedback Loop" component is critical, capturing in-workout user actions...</snippet>
        </doc>
        <doc>
            <path>docs/ux-design-direction.md</path>
            <title>UX Design Direction</title>
            <section>Flow 9: Perform & Log Workout</section>
            <snippet>This screen provides an intuitive, efficient, and adaptable interface for logging workout sets during a session, with conceptual integration of music controls and BPM feedback from Flow 11.</snippet>
        </doc>
    </docs>
    <code>
      <!-- No existing code artifacts found relevant to this story. -->
    </code>
  </artifacts>
  <constraints>
    <constraint>Frontend must integrate music playback controls and BPM feedback into the existing Workout Player UI.</constraint>
    <constraint>All Spotify API calls for playback and feedback must be proxied through the FastAPI backend to ensure token security.</constraint>
  </constraints>
  <interfaces>
      <interface>
        <name>Music Feedback</name>
        <kind>REST Endpoint</kind>
        <signature>POST /music/feedback</signature>
        <path>apps/api/app/api/music.py</path>
      </interface>
  </interfaces>
  <tests>
      <standards>Frontend unit tests (Jest/RTL) for music control components, integration tests for Spotify SDK and API calls, E2E tests (Playwright) for in-workout music playback flow.</standards>
      <locations><location>apps/web/src/app/workout/player/</location></locations>
      <ideas>
          <idea>Unit test music playback controls (play/pause, skip) within the Workout Player UI.</idea>
          <idea>E2E test the full in-workout music playback and feedback loop, verifying proper logging of user interactions.</idea>
      </ideas>
  </tests>
</story-context>