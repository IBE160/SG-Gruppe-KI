<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.5</storyId>
    <title>User Profile Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-user-profile-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to be able to view and edit my profile information, goals, and equipment</iWant>
    <soThat>I can keep my personal details up to date</soThat>
    <tasks>
      - [ ] **Task 1: Frontend UI for User Profile Page** (AC: #1, #2)
        - [ ] Create a new page/route for user profile management.
        - [ ] Build the UI to display current profile information (name, goals, preferences, equipment, injuries, units).
        - [ ] Implement forms/input fields to allow editing of these details.
        - [ ] Implement client-side logic to fetch user data using `GET /api/v1/users/me`.
        - [ ] Implement client-side logic to submit updated data using `PUT /api/v1/users/me`.
      - [ ] **Task 2: Backend API for User Profile Management** (AC: #1, #2)
        - [ ] Ensure `GET /api/v1/users/me` endpoint in FastAPI correctly retrieves user data from Supabase `users` table. (Source: `tech-spec-epic-1.md#APIs-and-Interfaces`)
        - [ ] Ensure `PUT /api/v1/users/me` endpoint in FastAPI correctly updates user data in Supabase `users` table. (Source: `tech-spec-epic-1.md#APIs-and-Interfaces`)
        - [ ] Implement validation for incoming update data using Pydantic schemas (e.g., `UserProfileUpdate`). (Source: `tech-spec-epic-1.md#Services-and-Modules`)
        - [ ] Ensure Row-Level Security (RLS) is enforced for all user profile operations.
      - [ ] **Task 3: Data Model &amp; Schema Verification** (AC: #1, #2)
        - [ ] Verify that the `users` table schema in Supabase (`id`, `email`, `name`, `goals`, `preferences`, `equipment`, `injuries`, `units`) supports all required fields for profile management. (Source: `tech-spec-epic-1.md#Data-Models-and-Contracts`)
        - [ ] Verify that Pydantic schemas in `app/schemas/user.py` are aligned with the `users` table for updates.
      - [ ] **Task 4: Testing** (AC: #1, #2)
        - [ ] Add Pytest integration tests for `GET /api/v1/users/me` and `PUT /api/v1/users/me` endpoints.
        - [ ] Add React Testing Library tests for the frontend profile components.
        - [ ] Add Playwright E2E test for navigating to the profile page, editing details, and saving changes successfully.
    </tasks>
  </story>

  <acceptanceCriteria>
    1.  **Given** an authenticated user, **when** they navigate to their profile page, **then** they can see their current profile information, goals, and equipment.
    2.  **And** they can edit these details and save the changes.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>ibe160 - Epic Breakdown</title>
        <section>Story 1.5: User Profile Management</section>
        <snippet>As a User, I want to be able to view and edit my profile information, goals, and equipment, so that I can keep my personal details up to date.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Core Platform &amp; User Foundation</title>
        <section>User Profile Endpoints (FastAPI `app/api/v1/users.py`)</section>
        <snippet>GET /api/v1/users/me, PUT /api/v1/users/me</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Data Architecture</section>
        <snippet>The `users` table will store goals (JSONB), preferences (JSONB), equipment (TEXT[]), injuries (TEXT), and units (TEXT).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Security Architecture</section>
        <snippet>Row-Level Security (RLS) will be strictly enforced on the `users` table to ensure that users can only read, write, or update their own profile data.</snippet>
      </doc>
    </docs>
    <code>
      <code-artifact>
        <path>backend/app/api/v1/users.py</path>
        <kind>api</kind>
        <symbol>GET /api/v1/users/me, PUT /api/v1/users/me</symbol>
        <lines></lines>
        <reason>This file will contain the API endpoints for fetching and updating user profile data.</reason>
      </code-artifact>
      <code-artifact>
        <path>backend/app/schemas/user.py</path>
        <kind>schema</kind>
        <symbol>UserProfileUpdate</symbol>
        <lines></lines>
        <reason>This file will contain the Pydantic schema for validating user profile update requests.</reason>
      </code-artifact>
    </code>
    <dependencies>
      <ecosystem name="Node">
        <dependency name="@faker-js/faker" version="^10.1.0" type="dev" />
        <dependency name="@playwright/test" version="^1.56.1" type="dev" />
      </ecosystem>
      <ecosystem name="Python">
        <dependency name="fastapi" version="" type="runtime" />
        <dependency name="uvicorn" version="" type="runtime" />
        <dependency name="python-dotenv" version="" type="runtime" />
        <dependency name="supabase-py" version="" type="runtime" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>User authentication must be handled by Supabase Auth.</constraint>
    <constraint>The API must be RESTful and use JSON for requests and responses.</constraint>
    <constraint>Error handling should follow the defined API contract, using standard HTTP status codes.</constraint>
    <constraint>Data models must align with the schema in architecture.md.</constraint>
    <constraint>Row-Level Security (RLS) must be enforced on the `users` table.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Get User Profile</name>
      <kind>REST Endpoint</kind>
      <signature>GET /api/v1/users/me</signature>
      <path>backend/app/api/v1/users.py</path>
    </interface>
    <interface>
      <name>Update User Profile</name>
      <kind>REST Endpoint</kind>
      <signature>PUT /api/v1/users/me</signature>
      <path>backend/app/api/v1/users.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Backend unit tests should be written with Pytest. Frontend component tests should use React Testing Library. End-to-end tests for user flows should be implemented with Playwright.
    </standards>
    <locations>
      <location type="E2E">/tests/e2e/</location>
      <location type="Backend">/backend/tests/</location>
      <location type="Frontend">Component-colocated tests or a central /app/tests/ directory.</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">Write an API test for the `GET /api/v1/users/me` and `PUT /api/v1/users/me` endpoints.</idea>
      <idea ac_id="1, 2">Write a UI component test for the profile editing form.</idea>
      <idea ac_id="1, 2">Write a full E2E test using Playwright that navigates to the profile, edits details, saves, and verifies the changes.</idea>
    </ideas>
  </tests>
</story-context>
